== Mirror using oc-mirror v2

.NOTE: Still in tech-preview



Setup environment

.Install requirements
----
sudo dnf install -y nmstate
mkdir ~/bin
cd ~/bin
wget https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/openshift-client-linux.tar.gz
tar zxvf openshift-client-linux.tar.gz
----

.env.sh
----
export QUAY_HOST_NAME=quayhostname
export QUAY_PORT=8443
export QUAY_USER=admin
export QUAY_PWD=admin123456
export QUAY_TOKEN=$(echo -n $QUAY_USER:$QUAY_PWD | base64)
export MIRROR_REPO=mirror
----


.imageSetConfiguration-v2-4.16.16.yaml
----
kind: ImageSetConfiguration
apiVersion: mirror.openshift.io/v2alpha1
mirror:
  platform:
    channels:
    - name: stable-4.16
      minVersion: 4.16.16
      maxVersion: 4.16.17
    graph: true
  operators:
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.16
      packages:
       - name: kubevirt-hyperconverged
       - name: mtv-operator
       - name: local-storage-operator
       - name: lvms-storage-operator
       - name: kubernetes-nmstate-operator
       - name: web-terminal
  additionalImages:
  - name: quay.io/edge-infrastructure/assisted-installer-agent:latest
  - name: quay.io/edge-infrastructure/assisted-installer:latest
  - name: quay.io/edge-infrastructure/assisted-installer-controller:latest
  - name: quay.io/sclorg/postgresql-12-c8s:latest
  - name: quay.io/edge-infrastructure/assisted-image-service:latest
  - name: quay.io/edge-infrastructure/assisted-service:latest
  - name: quay.io/edge-infrastructure/assisted-service:latest
  - name: quay.io/edge-infrastructure/assisted-installer-ui:latest
  - name: quay.io/openshift-release-dev/ocp-release:4.16.16-x86_64
  - name: quay.io/karmab/aicli
  - name: registry.redhat.io/rhel9/support-tools:latest
  - name: registry.redhat.io/ubi8/ubi:latest
  - name: registry.redhat.io/openshift4/ose-cli:latest
  - name: registry.redhat.io/ubi9/ubi:latest

----

=== Direct Registry to Registry mirror

.Mirror Direct
----
mkdir ~/working-dir
cp imageset-config-v2.yaml ~/working-dir
cd ~/working-dir
oc mirror -c imageset-config-v2.yaml --workspace file://$PWD docker://$QUAY_HOST_NAME:$QUAY_PORT/$MIRROR_REPO --v2
----


----
